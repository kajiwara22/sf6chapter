# ADR-007: Cloud Schedulerの実行間隔最適化

- **ステータス**: 承認
- **決定日**: 2026-01-02
- **決定者**: kajiwara22
- **関連ADR**: [ADR-001: クラウドサービス選定](./001-cloud-service-selection.md), [ADR-006: Firestoreによる重複防止](./006-firestore-for-duplicate-prevention.md)

## 1. 議論の背景

新着動画検知のためのCloud Scheduler実行間隔とYouTube API呼び出しパラメータを最適化する必要がある。

### 前提条件（ADR-001より）

- **配信頻度**: 1日1回〜数回程度
- **動画の長さ**: 30分〜1時間/本
- **対象動画**: 自分の配信動画のみ（`forMine=True`を使用）

### 技術的制約

- `forMine=True`を使用する場合、`publishedAfter`パラメータは使用できない
- YouTube API search.listは1回あたり100 quota unitsを消費
- YouTube Data API v3の無料枠: 10,000 units/日

## 2. 選択肢と結論

### 結論

**2時間間隔での実行**を採用する。

| パラメータ | 設定値 | 理由 |
|-----------|--------|------|
| Cloud Scheduler実行間隔 | **2時間** | 配信頻度（1日1-数回）に最適 |
| 動画公開日時フィルタ範囲 | **2.5時間** | 30分のバッファで取りこぼし防止 |
| `maxResults` | **5件** | 2時間で最大2-3本を想定 |

### 検討した選択肢

| ID | 実行間隔 | フィルタ範囲 | maxResults | 1日の実行回数 | API消費 units/日 |
|----|---------|-------------|-----------|--------------|-----------------|
| A | 15分 | 30分 | 10 | 96回 | 9,600 |
| B | 30分 | 45分 | 20 | 48回 | 4,800 |
| C | 1時間 | 1.5時間 | 5 | 24回 | 2,400 |
| D | **2時間（採用）** | **2.5時間** | **5** | **12回** | **1,200** |
| E | 4時間 | 5時間 | 5 | 6回 | 600 |

## 3. 各選択肢の比較

### 選択肢A: 15分間隔

**不採用理由**:
- API quota消費が過剰（9,600 units/日、無料枠の96%）
- 配信頻度（1日1-数回）に対して実行回数が多すぎる（96回/日）
- 検知速度向上のメリットが小さい（30分→15分）

### 選択肢B: 30分間隔

**不採用理由**:
- API quota消費が多い（4,800 units/日、無料枠の48%）
- 配信頻度に対して実行回数が多い（48回/日）
- maxResults=20は過剰（30分で20本の投稿はありえない）

### 選択肢C: 1時間間隔

**採用しなかった理由**:
- バランスは良いが、2時間間隔で十分と判断
- API quota削減の余地あり

### 選択肢D: 2時間間隔（採用）

**採用理由**:
1. **配信実態との整合性**
   - 1日1-数回の配信 → 最悪ケース1日6本（4時間間隔）でも十分カバー
   - 1本30分-1時間 → 2時間で2-3本程度を想定

2. **API quota効率**
   - 1,200 units/日（無料枠の12%）
   - 選択肢Bと比較して75%削減

3. **取りこぼし防止**
   - 2時間間隔 + 2.5時間フィルタ = **30分のバッファ**
   - Cloud Schedulerの遅延やネットワーク障害に対応

4. **Firestoreとの組み合わせ**
   - ADR-006で導入したFirestore重複防止により、万が一の重複検知も安全
   - Pub/Subの7日間保持により、ローカルPC停止中も検知漏れなし

### 選択肢E: 4時間間隔

**不採用理由**:
- API quota効率は最高（600 units/日）
- ただし、配信直後の検知が遅くなる（最大4時間遅延）
- 2時間間隔で十分効率的なため、あえて遅延を大きくする必要なし

## 4. 実装詳細

### パラメータ設定

```python
# Cloud Schedulerの実行間隔（2時間毎）
SCHEDULE_INTERVAL_MINUTES = 120

# 取得対象とする動画の最大経過時間（2.5時間、余裕を持たせる）
ACCEPTABLE_AGE_MINUTES = 150

# 取得する動画の最大件数（2時間で2-3本程度を想定）
MAX_RESULTS = 5
```

### 動作フロー

1. **Cloud Schedulerが2時間毎に起動**
2. **YouTube API呼び出し**
   - `forMine=True`で自分の動画を取得
   - `maxResults=5`で最新5件を取得
   - `order=date`で新しい順にソート
3. **日時フィルタ**
   - 取得した動画のうち、2.5時間以内に公開されたもののみ抽出
   - `publishedAfter`が使えないため、Pythonで手動フィルタ
4. **Firestore重複チェック**
   - 既に処理済みの動画は除外
5. **Pub/Subに発行**
   - 未処理動画のみキューに追加

### Cloud Scheduler設定

```bash
gcloud scheduler jobs create http check-new-video-job \
  --schedule="0 */2 * * *" \  # 2時間毎（偶数時に実行: 0時、2時、4時...）
  --uri="https://REGION-PROJECT_ID.cloudfunctions.net/check-new-video" \
  --http-method=GET \
  --time-zone="Asia/Tokyo"
```

## 5. 帰結

### 5.1 メリット

| 観点 | 効果 |
|------|------|
| **API quota効率** | 無料枠の12%のみ使用（1,200/10,000 units） |
| **コスト削減** | API呼び出しを75%削減（4,800→1,200 units/日） |
| **取りこぼし防止** | 30分のバッファで遅延・障害に対応 |
| **配信実態との整合** | 1日1-数回の配信に最適化 |
| **システム負荷軽減** | Cloud Functions, Firestoreの呼び出し回数削減 |

### 5.2 トレードオフ

| デメリット | 対策 |
|-----------|------|
| 配信後の検知が最大2時間遅延 | Pub/Subの7日間保持で検知漏れなし |
| 連続配信時に一時的に遅れる可能性 | Firestoreで重複防止、バッファ30分で通常は問題なし |

### 5.3 監視指標

以下の指標を監視し、必要に応じて間隔を調整する：

1. **取りこぼし率**: 発行された動画のうち、検知できなかった割合（目標: 0%）
2. **検知遅延時間**: 動画公開から検知までの時間（目標: 2時間以内）
3. **API quota使用率**: 1日のAPI quota消費量（目標: 20%以下）
4. **重複検知率**: Firestoreで弾かれた重複の割合（目標: 0%）

## 6. 将来の見直し条件

以下の場合、実行間隔の見直しを検討する：

### 6.1 配信頻度の増加

- **条件**: 1日5回以上の配信が常態化
- **対応**: 1時間間隔への短縮を検討

### 6.2 リアルタイム性の要求

- **条件**: 配信直後の検知が求められる（例: 視聴者への通知）
- **対応**: 30分間隔または1時間間隔への短縮

### 6.3 API quota制限の逼迫

- **条件**: 他のYouTube API利用で無料枠が逼迫
- **対応**: 4時間間隔への延長または課金枠の利用

### 6.4 複数チャンネル対応

- **条件**: 他のチャンネルも監視対象に追加
- **対応**: チャンネル数に応じた間隔調整または個別スケジュール

## 7. 参考資料

- [YouTube Data API v3 - Quota Usage](https://developers.google.com/youtube/v3/determine_quota_cost)
- [Cloud Scheduler Documentation](https://cloud.google.com/scheduler/docs)
- [ADR-001: クラウドサービス選定](./001-cloud-service-selection.md)
- [ADR-006: Firestoreによる重複防止](./006-firestore-for-duplicate-prevention.md)

---

**変更履歴**:
- 2026-01-02: 初版作成、2時間間隔を採用
