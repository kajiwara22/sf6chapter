# ADR-011: 中間ファイル保存による人間確認可能性の確保

## ステータス

採用（Accepted）

## 日付

2026-01-04

## コンテキスト

SF6チャプター生成システムでは、以下の自動処理を行っています:

1. テンプレートマッチングによる対戦シーン検出
2. Gemini APIによるキャラクター名認識
3. YouTube動画へのチャプター自動追加

しかし、以下の問題がありました:

### 誤検知の可能性

- **テンプレートマッチング**: 類似した画面（メニュー、リプレイなど）を誤検知する可能性
- **キャラクター認識**: Gemini APIの認識結果にブレがある
- **最終的な確認**: 自動生成されたチャプターが正しいか人間が確認できない

### 既存の問題点

- **常駐モード/ワンショットモード**: 中間ファイルが一切保存されない
- **テストモード**: 一部のみ保存（`./chapters/`）
- **検出フレーム**: メモリ上にのみ存在し、後から確認不可能
- **デバッグ困難**: 誤検知が発生した場合、原因を特定できない

## 決定事項

### 中間ファイルの包括的保存

すべての実行モード（常駐/ワンショット/テスト）で、以下の中間ファイルを保存します:

#### 保存ディレクトリ構造

```
./intermediate/{video_id}/
├── detection_summary.json       # 検出サマリー
├── frame_001_123s.png           # 検出フレーム画像
├── frame_002_456s.png
├── ...
├── video_data.json              # 動画メタデータ
├── matches.json                 # 対戦データ
└── chapters.json                # チャプターデータ
```

#### 1. 検出サマリー (`detection_summary.json`)

```json
{
  "videoId": "abc123",
  "detectedAt": "2026-01-04T10:30:00Z",
  "totalDetections": 10,
  "detections": [
    {
      "index": 1,
      "timestamp": 123.5,
      "frameNumber": 3705,
      "confidence": 0.85
    }
  ]
}
```

- **目的**: 検出処理の全体像を把握
- **保存タイミング**: テンプレートマッチング完了後

#### 2. 検出フレーム画像 (`frame_XXX_YYYs.png`)

- **ファイル名形式**: `frame_{index:03d}_{timestamp}s.png`
- **内容**: キャラクター名表示領域を切り抜いた画像
- **目的**: 誤検知の視覚的確認、Gemini API認識結果の検証
- **保存タイミング**: 各対戦シーン検出時

#### 3. 最終結果ファイル

- **`video_data.json`**: 動画メタデータと処理統計
- **`matches.json`**: 全対戦データ（キャラクター名、認識結果など）
- **`chapters.json`**: YouTubeチャプター情報
- **保存タイミング**: 全処理完了後

### 環境変数による設定

```bash
# 中間ファイル保存先ディレクトリ（デフォルト: ./intermediate）
INTERMEDIATE_DIR=./intermediate
```

### 人間確認ワークフロー

1. **自動処理完了**: 中間ファイルが `./intermediate/{video_id}/` に保存される
2. **視覚的確認**: 検出フレーム画像 (`frame_*.png`) を目視確認
3. **データ確認**: `detection_summary.json` と `matches.json` で認識結果を確認
4. **修正が必要な場合**:
   - `chapters.json` を手動編集
   - 修正後のファイルを使って再アップロード（将来実装予定）

## 根拠

### メリット

1. **品質保証**: 誤検知を人間が確認・修正可能
2. **デバッグ容易性**: 問題発生時に原因を特定しやすい
3. **トレーサビリティ**: 処理の全過程を記録として保持
4. **再処理可能性**: 中間ファイルから再処理や修正が可能

### デメリットと対策

1. **ディスク容量**: 画像ファイルが蓄積される
   - **対策**: 古いファイルの定期削除スクリプト（将来実装）
   - **見積もり**: 1動画あたり10対戦 × 200KB/画像 = 約2MB

2. **処理速度**: ファイル保存による若干のオーバーヘッド
   - **対策**: 非同期保存（将来最適化）
   - **影響**: 微小（1動画あたり数秒程度）

## 代替案

### A. 中間ファイルを保存しない（現状維持）

- **却下理由**: 誤検知を確認・修正できない

### B. エラー時のみ保存

- **却下理由**: 成功した処理でも誤検知がある可能性

### C. クラウドストレージに直接保存

- **却下理由**: ローカル確認が困難、コスト増加

## 関連事項

- [ADR-002: データ保存・検索基盤](002-data-storage-search.md) - R2への最終データ保存
- [ADR-006: Firestoreによる重複防止](006-firestore-for-duplicate-prevention.md) - 処理状態管理

## 参考資料

- OpenCV ドキュメント: Template Matching
- Gemini API ドキュメント: Vision capabilities
